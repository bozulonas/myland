import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import { Store } from "lucide-react";
import Image from "next/image";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "./ui/accordion";

type MarketplaceCategory = {
    category: string;
    content: string;
};

type MarketplaceProps = {
  categories: MarketplaceCategory[];
};

const MarkdownRenderer = ({ content }: { content: string }) => {
    return (
        <ReactMarkdown
            remarkPlugins={[remarkGfm]}
            components={{
                table: ({node, ...props}) => <div className="border rounded-md my-4"><Table {...props} /></div>,
                thead: ({node, ...props}) => <TableHeader {...props} />,
                tr: ({node, ...props}) => <TableRow {...props} />,
                th: ({node, ...props}) => <TableHead className="font-bold text-base" {...props} />,
                tbody: ({node, ...props}) => <TableBody {...props} />,
                td: ({node, ...props}) => <TableCell className="text-base text-foreground" {...props} />,
                p: ({node, ...props}) => <p className="text-muted-foreground" {...props} />,
                em: ({node, ...props}) => <em className="text-muted-foreground" {...props} />,
            }}
        >
            {content}
        </ReactMarkdown>
    );
};


export default function Marketplace({ categories }: MarketplaceProps) {
    if (!categories || categories.length === 0) {
        return (
          <div className="text-center text-muted-foreground py-16">
            <p>No items found in the marketplace.</p>
          </div>
        );
    }
    
    const armorAndWeapons = categories.filter(c => c.category === 'Armor' || c.category === 'Weapons');
    const transport = categories.find(c => c.category === 'Transport');
    const otherCategories = categories.filter(c => c.category !== 'Armor' && c.category !== 'Weapons' && c.category !== 'Transport');

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
            <Store />
            Marketplace
        </CardTitle>
      </CardHeader>
      <CardContent className="prose prose-sm max-w-none">
        <p className="text-muted-foreground italic">All prices are in gold pieces.</p>

        <div className="grid md:grid-cols-3 gap-8 items-start mb-8">
            <div className="md:col-span-2 space-y-2">
                {armorAndWeapons.map((category) => (
                    <Accordion type="single" collapsible defaultValue="Armor" key={category.category}>
                        <AccordionItem value={category.category}>
                            <AccordionTrigger className="text-2xl font-headline hover:no-underline bg-muted/50 px-4 rounded-md">
                                {category.category}
                            </AccordionTrigger>
                            <AccordionContent className="pt-2 px-4">
                                <MarkdownRenderer content={category.content} />
                            </AccordionContent>
                        </AccordionItem>
                    </Accordion>
                ))}
            </div>
            <div className="md:col-span-1 relative">
                <Image
                    src="https://www.oldbookart.com/wp-content/uploads/photo-gallery/Varia_Lot_7/Weapons/413.JPG?bwg=1590115859"
                    alt="A suit of armor"
                    width={413}
                    height={557}
                    className="rounded-lg object-contain"
                />
            </div>
        </div>

        {transport && (
             <div className="grid md:grid-cols-3 gap-8 items-start mb-8">
                <div className="md:col-span-1 relative order-last md:order-first">
                    <Image
                        src="https://www.oldbookart.com/wp-content/uploads/photo-gallery/David_Roberts_Egypt/At_Luxor__Thebes__Upper_Egypt.jpg?bwg=1589632068"
                        alt="Travelers in a desert city"
                        width={640}
                        height={458}
                        className="rounded-lg object-contain"
                    />
                </div>
                <div className="md:col-span-2 space-y-2">
                     <Accordion type="single" collapsible defaultValue="Transport">
                        <AccordionItem value={transport.category}>
                            <AccordionTrigger className="text-2xl font-headline hover:no-underline bg-muted/50 px-4 rounded-md">
                                {transport.category}
                            </AccordionTrigger>
                            <AccordionContent className="pt-2 px-4">
                                <MarkdownRenderer content={transport.content} />
                            </AccordionContent>
                        </AccordionItem>
                    </Accordion>
                </div>
            </div>
        )}

        <Accordion type="multiple" className="w-full space-y-2 mt-8">
          {otherCategories.map((category) => (
            <AccordionItem value={category.category} key={category.category}>
              <AccordionTrigger className="text-2xl font-headline hover:no-underline bg-muted/50 px-4 rounded-md">
                {category.category}
              </AccordionTrigger>
              <AccordionContent className="pt-2 px-4">
                <MarkdownRenderer content={category.content} />
              </AccordionContent>
            </AccordionItem>
          ))}
        </Accordion>
      </CardContent>
    </Card>
  );
}
